<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>Titula√ß√£o de PEEP</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: #eef2f7;
      color: #1a2b3c;
      padding: 12px;
      line-height: 1.5;
      min-height: 100vh;
    }
    
    h1 {
      font-size: 1.6rem;
      color: #005b96;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }
    
    h2 {
      font-size: 1.3rem;
      color: #005b96;
      margin-bottom: 10px;
    }
    
    p {
      margin-bottom: 12px;
      font-size: 0.95rem;
    }
    
    ul {
      margin-bottom: 15px;
      padding-left: 20px;
      font-size: 0.9rem;
    }
    
    li {
      margin-bottom: 6px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto 20px auto;
      background: white;
      padding: 16px;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .button-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    
    button {
      background-color: #005b96;
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 30px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 1 1 auto;
      min-width: 140px;
      -webkit-tap-highlight-color: transparent;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    button:active {
      background-color: #003f66;
      transform: scale(0.97);
    }
    
    button:focus-visible {
      outline: 3px solid #7ab3d9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    th {
      background-color: #005b96;
      color: white;
      font-weight: 500;
      font-size: 0.85rem;
      padding: 12px 6px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    td {
      padding: 12px 6px;
      text-align: center;
      border-bottom: 1px solid #e0e7ef;
      background-color: white;
      font-size: 0.9rem;
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    input[type="number"] {
      width: 70px;
      padding: 10px 6px;
      border: 1.5px solid #d0d9e5;
      border-radius: 12px;
      text-align: center;
      font-size: 1rem;
      background-color: #f8fafd;
      transition: border-color 0.2s;
    }
    
    input[type="number"]:focus {
      outline: none;
      border-color: #005b96;
      background-color: white;
    }
    
    #chart-container {
      margin: 20px 0;
      padding: 10px;
      background: #f8fafd;
      border-radius: 16px;
    }
    
    canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 280px;
      touch-action: pan-y pinch-zoom;
    }
    
    #minDP, #finalMinDP {
      text-align: center;
      font-size: 1.1rem;
      padding: 14px;
      background-color: #e3f0fa;
      border-radius: 30px;
      color: #005b96;
      margin-top: 15px;
    }
    
    #step2, #step3 {
      display: none;
    }
    
    .card-info {
      background-color: #f0f7ff;
      border-left: 4px solid #005b96;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    
    @media (max-width: 380px) {
      body {
        padding: 8px;
      }
      
      .container {
        padding: 12px;
      }
      
      h1 {
        font-size: 1.4rem;
      }
      
      h2 {
        font-size: 1.2rem;
      }
      
      button {
        padding: 12px 16px;
        font-size: 0.95rem;
        min-width: 120px;
      }
      
      th {
        font-size: 0.75rem;
        padding: 10px 3px;
      }
      
      td {
        padding: 10px 3px;
        font-size: 0.85rem;
      }
      
      input[type="number"] {
        width: 60px;
        padding: 8px 4px;
      }
    }
    
    @media (hover: hover) {
      button:hover {
        background-color: #003f66;
      }
    }
    
    .peep-value {
      font-weight: 600;
      color: #005b96;
    }
    
    .warning-note {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Titula√ß√£o Decremental da PEEP</h1>

    <div id="step1">
      <div class="button-container">
        <button onclick="goToStep2()">‚ñ∂Ô∏è Iniciar Passo 2</button>
      </div>
      
      <div class="card-info">
        <strong>‚ö†Ô∏è Importante:</strong> Certifique-se de que o paciente est√° est√°vel antes de iniciar.
      </div>
      
      <h2>Passo 1: MODO PCV</h2>
      <p>Instru√ß√µes sequenciais:</p>
      <ul>
        <li>üîπ Aumentar PEEP para <strong>15 cmH2O</strong> (10 segundos)</li>
        <li>üîπ Aumentar PEEP para <strong>20 cmH2O</strong> (10 segundos)</li>
        <li>üîπ Aumentar PEEP para <strong>26 cmH2O</strong> (30 segundos)</li>
      </ul>
      
      <table>
        <thead>
          <tr>
            <th>Pinsp</th>
            <th>FR</th>
            <th>TI</th>
            <th>I:E</th>
            <th>FiO2</th>
            <th>PEEP</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>15</td>
            <td>10</td>
            <td>3s</td>
            <td>1:1</td>
            <td>100%</td>
            <td>10</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="step2">
      <div class="button-container">
        <button onclick="goToStep1()">‚¨ÖÔ∏è Retornar</button>
        <button onclick="goToStep3()">Passo 3 ‚û°Ô∏è</button>
      </div>
      
      <h2>Passo 2: Titula√ß√£o</h2>
      <div class="card-info">
        <strong>Configura√ß√£o:</strong> VC 6 ml/kg | FR 20 | I:E 1:2 | FiO2 100%<br>
        Iniciar em PEEP 26 cmH2O
      </div>
      
      <div style="overflow-x: auto; margin-bottom: 15px; border-radius: 12px;">
        <table>
          <thead>
            <tr>
              <th>PEEP</th>
              <th>Pplat</th>
              <th>DP</th>
            </tr>
          </thead>
          <tbody id="peepTable"></tbody>
        </table>
      </div>
      
      <div id="chart-container">
        <canvas id="peepChart"></canvas>
        <div id="minDP"></div>
      </div>
    </div>

    <div id="step3">
      <div class="button-container">
        <button onclick="goToStep1()">üè† In√≠cio</button>
        <button id="sendPdfButton">üìß Enviar PDF</button>
      </div>
      
      <h2>Passo 3: Retorno ao PCV</h2>
      <ul>
        <li>üîπ Aumentar PEEP para <strong>15 cmH2O</strong> (10s)</li>
        <li>üîπ Aumentar PEEP para <strong>20 cmH2O</strong> (10s)</li>
        <li>üîπ Aumentar PEEP para <strong>26 cmH2O</strong> (30s)</li>
      </ul>
      
      <table>
        <thead>
          <tr>
            <th>Pinsp</th>
            <th>FR</th>
            <th>TI</th>
            <th>I:E</th>
            <th>FiO2</th>
            <th>PEEP</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>15</td>
            <td>10</td>
            <td>3s</td>
            <td>1:1</td>
            <td>100%</td>
            <td>10</td>
          </tr>
        </tbody>
      </table>
      
      <div class="warning-note">
        <strong>üìå PEEP ideal:</strong> Ajuste para o valor encontrado no Passo 2
      </div>
      
      <p id="finalMinDP" style="font-weight: bold;"></p>
    </div>
  </div>

  <script>
    let chartInstance;
    let minPEEP;

    function goToStep2() {
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
      createPeepTable();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToStep3() {
      document.getElementById('step2').style.display = 'none';
      document.getElementById('step3').style.display = 'block';
      const minDPText = document.getElementById('minDP').textContent;
      document.getElementById('finalMinDP').textContent = minDPText || 'Nenhum dado registrado';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToStep1() {
      window.location.reload();
    }

    function createPeepTable() {
      const peepValues = [26, 24, 22, 20, 18, 16, 14, 12, 10, 8, 6];
      const tableBody = document.getElementById('peepTable');
      tableBody.innerHTML = '';

      peepValues.forEach(peep => {
        const row = document.createElement('tr');

        const peepCell = document.createElement('td');
        peepCell.textContent = peep;
        peepCell.className = 'peep-value';
        row.appendChild(peepCell);

        const pplatCell = document.createElement('td');
        const pplatInput = document.createElement('input');
        pplatInput.type = 'number';
        pplatInput.placeholder = 'Pplat';
        pplatInput.inputMode = 'numeric';
        pplatInput.oninput = calculateDP;
        pplatCell.appendChild(pplatInput);
        row.appendChild(pplatCell);

        const dpCell = document.createElement('td');
        dpCell.textContent = '-';
        row.appendChild(dpCell);

        tableBody.appendChild(row);
      });
    }

    function calculateDP() {
      const rows = document.querySelectorAll('#peepTable tr');
      let minDP = Infinity;
      minPEEP = null;

      rows.forEach(row => {
        const peep = parseInt(row.cells[0].textContent);
        const pplatInput = row.cells[1].querySelector('input');
        const dpCell = row.cells[2];

        if (pplatInput.value) {
          const pplat = parseFloat(pplatInput.value);
          const dp = pplat - peep;
          dpCell.textContent = dp.toFixed(1);

          if (dp < minDP || (dp === minDP && peep < minPEEP)) {
            minDP = dp;
            minPEEP = peep;
          }
        } else {
          dpCell.textContent = '-';
        }
      });

      updateChart();
    }

    function updateChart() {
      const rows = document.querySelectorAll('#peepTable tr');
      const peepValues = [];
      const dpValues = [];

      rows.forEach(row => {
        const peep = parseInt(row.cells[0].textContent);
        const dpText = row.cells[2].textContent;
        if (dpText !== '-' && !isNaN(dpText)) {
          peepValues.push(peep);
          dpValues.push(parseFloat(dpText));
        }
      });

      if (peepValues.length === 0) return;

      const ctx = document.getElementById('peepChart').getContext('2d');
      if (chartInstance) {
        chartInstance.destroy();
      }
      
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: peepValues,
          datasets: [{
            label: 'Driving Pressure',
            data: dpValues,
            borderColor: '#005b96',
            backgroundColor: 'rgba(0, 91, 150, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: dpValues.map(dp => dp === Math.min(...dpValues) ? '#dc3545' : '#005b96'),
            pointRadius: dpValues.map(dp => dp === Math.min(...dpValues) ? 8 : 4),
            pointHoverRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#005b96',
              titleColor: 'white',
              bodyColor: 'white',
              cornerRadius: 8,
              padding: 10
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'PEEP (cmH2O)',
                font: { size: 12, weight: 'bold' }
              },
              grid: { display: false }
            },
            y: {
              title: {
                display: true,
                text: 'DP (cmH2O)',
                font: { size: 12, weight: 'bold' }
              },
              beginAtZero: true,
              grid: { color: '#e0e7ef' }
            }
          }
        }
      });

      if (minPEEP !== null) {
        document.getElementById('minDP').innerHTML = `‚úÖ <strong>PEEP ideal: ${minPEEP} cmH2O</strong> (menor Driving Pressure)`;
      }
    }

    async function generateAndSendPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(20);
      doc.text('Titula√ß√£o Decremental da PEEP', 14, 20);
      
      doc.setFontSize(14);
      doc.text('Passo 1: MODO PCV', 14, 30);
      doc.setFontSize(10);
      doc.text('Instru√ß√µes:', 14, 38);
      doc.text('‚Ä¢ PEEP 15 cmH2O - 10s', 14, 44);
      doc.text('‚Ä¢ PEEP 20 cmH2O - 10s', 14, 50);
      doc.text('‚Ä¢ PEEP 26 cmH2O - 30s', 14, 56);
      
      doc.autoTable({
        startY: 65,
        head: [['Pinsp', 'FR', 'TI', 'I:E', 'FiO2', 'PEEP']],
        body: [['15', '10', '3s', '1:1', '100%', '10']],
        theme: 'grid',
        headStyles: { fillColor: [0, 91, 150] }
      });

      doc.addPage();
      doc.setFontSize(14);
      doc.text('Passo 2: Titula√ß√£o', 14, 20);
      
      const tableRows = [];
      const rows = document.querySelectorAll('#peepTable tr');
      rows.forEach(row => {
        const peep = row.cells[0].textContent;
        const pplat = row.cells[1].querySelector('input')?.value || '-';
        const dp = row.cells[2].textContent;
        tableRows.push([peep, pplat, dp]);
      });
      
      doc.autoTable({
        startY: 28,
        head: [['PEEP', 'Pplat', 'DP']],
        body: tableRows,
        theme: 'grid',
        headStyles: { fillColor: [0, 91, 150] }
      });

      const chartCanvas = document.getElementById('peepChart');
      if (chartCanvas) {
        const chartImage = chartCanvas.toDataURL('image/png');
        doc.addPage();
        doc.setFontSize(14);
        doc.text('Gr√°fico PEEP x Driving Pressure', 14, 20);
        doc.addImage(chartImage, 'PNG', 10, 30, 190, 100);
      }

      doc.addPage();
      doc.setFontSize(14);
      doc.text('Passo 3: Retorno ao PCV', 14, 20);
      doc.setFontSize(10);
      doc.text('Instru√ß√µes:', 14, 28);
      doc.text('‚Ä¢ PEEP 15 cmH2O - 10s', 14, 34);
      doc.text('‚Ä¢ PEEP 20 cmH2O - 10s', 14, 40);
      doc.text('‚Ä¢ PEEP 26 cmH2O - 30s', 14, 46);
      
      doc.autoTable({
        startY: 55,
        head: [['Pinsp', 'FR', 'TI', 'I:E', 'FiO2', 'PEEP']],
        body: [['15', '10', '3s', '1:1', '100%', '10']],
        theme: 'grid',
        headStyles: { fillColor: [0, 91, 150] }
      });

      const minDPText = document.getElementById('minDP')?.textContent || '';
      if (minDPText) {
        doc.setFontSize(12);
        doc.text(minDPText, 14, 90);
      }

      const pdfBlob = doc.output('blob');
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(pdfBlob);
      link.download = 'titulacao_peep.pdf';
      link.click();
      
      alert('üìÑ PDF gerado com sucesso!');
    }

    document.getElementById('sendPdfButton')?.addEventListener('click', generateAndSendPDF);
  </script>
</body>
</html>
